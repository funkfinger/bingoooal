---
import { createSupabaseServerClient } from '../lib/supabaseServer';

const supabase = createSupabaseServerClient(Astro.cookies);

console.log('Logout page accessed');

// Sign out on the server side (clears cookies)
const { error } = await supabase.auth.signOut();

if (error) {
  console.error('Error signing out:', error);
  // Even if there's an error, manually clear all Supabase cookies
}

// Manually delete all Supabase-related cookies to ensure clean logout
const cookieOptions = {
  path: '/',
  maxAge: 0, // Expire immediately
};

// Delete all possible Supabase cookie variations
Astro.cookies.delete('sb-access-token', cookieOptions);
Astro.cookies.delete('sb-refresh-token', cookieOptions);
Astro.cookies.delete('sb-auth-token', cookieOptions);

// Delete cookies with the project-specific prefix
const projectRef = import.meta.env.PUBLIC_SUPABASE_URL.match(/https:\/\/([^.]+)/)?.[1];
if (projectRef) {
  Astro.cookies.delete(`sb-${projectRef}-auth-token`, cookieOptions);
  Astro.cookies.delete(`sb-${projectRef}-auth-token.0`, cookieOptions);
  Astro.cookies.delete(`sb-${projectRef}-auth-token.1`, cookieOptions);
}

console.log('User signed out, cookies cleared, redirecting to login');

// Redirect to login page
return Astro.redirect('/login');
---

