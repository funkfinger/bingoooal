---
import { createSupabaseServerClient } from '../../lib/supabaseServer';

const supabase = createSupabaseServerClient(Astro.cookies);

// Get the URL parameters
const requestUrl = new URL(Astro.request.url);
const code = requestUrl.searchParams.get('code');
const error_description = requestUrl.searchParams.get('error_description');
const error = requestUrl.searchParams.get('error');
const next = requestUrl.searchParams.get('next') || '/dashboard';

// Handle POST request from client-side (implicit flow)
if (Astro.request.method === 'POST') {
  try {
    const body = await Astro.request.json();
    const { access_token, refresh_token } = body;

    console.log('Setting session from POST request (implicit flow)');

    if (access_token && refresh_token) {
      const { data, error } = await supabase.auth.setSession({
        access_token,
        refresh_token,
      });

      if (error) {
        console.error('Error setting session:', error);
        return new Response(JSON.stringify({ error: error.message }), {
          status: 400,
          headers: { 'Content-Type': 'application/json' },
        });
      }

      console.log('Session set successfully on server:', data.session?.user?.email);
      return new Response(JSON.stringify({ success: true }), {
        status: 200,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    return new Response(JSON.stringify({ error: 'Missing tokens' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (err) {
    console.error('Error processing POST request:', err);
    return new Response(JSON.stringify({ error: 'Invalid request' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json' },
    });
  }
}

console.log('Callback received:', {
  code: code ? 'present' : 'missing',
  error,
  error_description,
  url: requestUrl.href,
  searchParams: Object.fromEntries(requestUrl.searchParams)
});

// Check for OAuth errors (but ignore 'no_code' as it might be using implicit flow)
if (error_description) {
  console.error('OAuth error:', error_description);
  return Astro.redirect(`/login?error=${encodeURIComponent(error_description)}`);
}

// Handle PKCE flow (code in query params)
if (code) {
  const { data, error } = await supabase.auth.exchangeCodeForSession(code);

  if (error) {
    console.error('Error exchanging code for session:', error);
    return Astro.redirect(`/login?error=${encodeURIComponent(error.message)}`);
  }

  console.log('Session created successfully:', data.session?.user?.email);
  return Astro.redirect(next);
}

// If no code, it might be using implicit flow (tokens in hash fragment)
// Let the client-side script handle it
console.log('No code in query params, checking for tokens in hash fragment...');
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authenticating...</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .container {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        max-width: 500px;
        width: 90%;
        text-align: center;
      }
      .status {
        font-size: 3rem;
        margin-bottom: 1rem;
      }
      h1 {
        margin: 0 0 0.5rem 0;
        color: #333;
      }
      p {
        color: #666;
        margin: 0.5rem 0;
      }
      .error {
        background: #fee;
        border: 1px solid #fcc;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
        color: #c33;
      }
      .debug {
        background: #f5f5f5;
        border: 1px solid #ddd;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
        font-family: monospace;
        font-size: 0.85rem;
        text-align: left;
        max-height: 300px;
        overflow-y: auto;
      }
      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 1rem auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      button {
        margin-top: 1rem;
        padding: 0.75rem 1.5rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 1rem;
      }
      button:hover {
        background: #5568d3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="status" id="status">üîê</div>
      <h1 id="title">Authenticating...</h1>
      <p id="message">Please wait while we complete your login.</p>
      <div class="spinner" id="spinner"></div>
      <div id="error" class="error" style="display: none;"></div>
      <div id="debug" class="debug" style="display: none;"></div>
      <button id="retry" style="display: none;" onclick="window.location.href='/login'">Back to Login</button>
    </div>

    <script>
      import { supabase } from '../../lib/supabase';

      const statusEl = document.getElementById('status');
      const titleEl = document.getElementById('title');
      const messageEl = document.getElementById('message');
      const spinnerEl = document.getElementById('spinner');
      const errorEl = document.getElementById('error');
      const debugEl = document.getElementById('debug');
      const retryBtn = document.getElementById('retry');

      function showError(title, message, debugInfo) {
        statusEl.textContent = '‚ùå';
        titleEl.textContent = title;
        messageEl.textContent = message;
        spinnerEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = message;
        retryBtn.style.display = 'block';

        if (debugInfo) {
          debugEl.style.display = 'block';
          debugEl.textContent = JSON.stringify(debugInfo, null, 2);
        }
      }

      async function handleCallback() {
        try {
          // Check if there are tokens in the URL hash
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const accessToken = hashParams.get('access_token');
          const refreshToken = hashParams.get('refresh_token');
          const errorParam = hashParams.get('error');
          const errorDescription = hashParams.get('error_description');

          const debugInfo = {
            hasAccessToken: !!accessToken,
            hasRefreshToken: !!refreshToken,
            error: errorParam,
            errorDescription: errorDescription,
            fullHash: window.location.hash,
            fullUrl: window.location.href,
          };

          console.log('Client-side callback check:', debugInfo);

          // Check for errors in hash
          if (errorParam) {
            showError(
              'Authentication Failed',
              errorDescription || errorParam,
              debugInfo
            );
            return;
          }

          if (accessToken && refreshToken) {
            // Implicit flow: Send tokens to server to set session
            console.log('Sending tokens to server...');
            messageEl.textContent = 'Setting up your session...';

            try {
              const response = await fetch('/auth/callback', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  access_token: accessToken,
                  refresh_token: refreshToken,
                }),
              });

              const result = await response.json();

              if (!response.ok || result.error) {
                console.error('Error setting session on server:', result.error);
                showError(
                  'Session Error',
                  result.error || 'Failed to set session',
                  { ...debugInfo, serverError: result }
                );
                return;
              }

              console.log('Session set successfully on server');
              statusEl.textContent = '‚úÖ';
              titleEl.textContent = 'Success!';
              messageEl.textContent = 'Login successful! Redirecting...';

              // Redirect after a short delay so user can see success message
              setTimeout(() => {
                window.location.href = '/dashboard';
              }, 1000);
            } catch (fetchError) {
              console.error('Error communicating with server:', fetchError);
              showError(
                'Server Error',
                'Failed to communicate with server',
                { ...debugInfo, fetchError: fetchError.toString() }
              );
            }
          } else {
            // No tokens found anywhere
            console.error('No authentication data found in callback');
            showError(
              'No Authentication Data',
              'No access token or refresh token found in the callback URL.',
              debugInfo
            );
          }
        } catch (err) {
          console.error('Callback error:', err);
          showError(
            'Unexpected Error',
            err.message || 'An unexpected error occurred',
            { error: err.toString(), stack: err.stack }
          );
        }
      }

      handleCallback();
    </script>
  </body>
</html>

